#!/bin/bash

printGreen() {
    echo -e "\033[32m$1\033[0m"
}

printLine() {
    echo "------------------------------"
}

# MICTONODE ASCII logosunu gösterme fonksiyonu
function printMictoNode {
  echo -e "${GREEN}"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@=======================================================================================+@"
  echo "@ =%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                           .@"
  echo "@ +@@@*******@@@@@@@@@@@@@@@@@@@@@%******#@@@      .:::::::                 .:::::.     .@"
  echo "@ +@@#       :%@@@@@@@@@@@@@@@@@@*       .@@@      -@@@@@@@@=               =@@@@@+     .@"
  echo "@ +@@#         *@@@@@@@@@@@@@@@@-        .@@@      -@@@@@@@@@%-             =@@@@@+     .@"
  echo "@ +@@#          -@@@@@@@@@@@@@#.         .@@@      -@@@@@@@@@@@#.           =@@@@@+     .@"
  echo "@ +@@#           .#@@@@@@@@@@=           .@@@      -@@@@@%@@@@@@@*.         =@@@@@+     .@"
  echo "@ +@@#      .      +@@@@@@@%:      .     .@@@      -@@@@@* +@@@@@@@=        =@@@@@+     .@"
  echo "@ +@@#      @=      :%@@@@*       #*     .@@@      -@@@@@*  .*@@@@@@%-      =@@@@@+     .@"
  echo "@ +@@#      @@*       *@@-      :@@*     .@@@      -@@@@@*    :#@@@@@@%:    =@@@@@+     .@"
  echo "@ +@@#      @@@%:      -.      +@@@*     .@@@      -@@@@@*      -%@@@@@@*.  =@@@@@+     .@"
  echo "@ +@@#      @@@@@+           .%@@@@*     .@@@      -@@@@@*        =@@@@@@@+ =@@@@@+     .@"
  echo "@ +@@#      @@@@@@%.        =@@@@@@*     .@@@      -@@@@@*          *@@@@@@@#@@@@@+     .@"
  echo "@ +@@#      @@@@@@@@-      *@@@@@@@*     .@@@      -@@@@@*           .#@@@@@@@@@@@+     .@"
  echo "@ +@@#      @@@@@@@@@%%%%%@@@@@@@@@*     .@@@      -@@@@@*             :%@@@@@@@@@+     .@"
  echo "@ +@@#      @@@@@@@@@@@@@@@@@@@@@@@*     .@@@      -@@@@@*               =@@@@@@@@+     .@"
  echo "@ +@@@+++++*@@@@@@@@@@@@@@@@@@@@@@@%+++++*@@@      .-----:                 -------:     .@"
  echo "@ +%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%                                           .@"
  echo "@========================================================================================@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@CoreNodeCommunity"
  echo -e "${NC}"
}

# MICTONODE logosunu göster
printMictoNode

# Paket ve bağımlılıkların yüklenmesi
printGreen "1. Updating and installing dependencies..."
sudo apt update && sudo apt upgrade -y
sudo apt install curl git wget htop tmux build-essential jq make lz4 gcc unzip -y

# kullanıcı girdileri
read -p "Enter WALLET name:" W_WALLET
echo 'export W_WALLET='$W_WALLET
read -p "Enter your MONIKER :" W_MONIKER
echo 'export W_MONIKER='$W_MONIKER
read -p "Enter your PORT (3-digit) :" W_PORT
echo 'export W_PORT='$W_PORT

# varyasyonları ayarlama
echo "export WALLET="$W_MONIKER"" >> $HOME/.bash_profile
echo "export MONIKER="$W_MONIKER"" >> $HOME/.bash_profile
echo "export WARDEN_CHAIN_ID="chiado_10010-1"" >> $HOME/.bash_profile
echo "export WARDEN_PORT="$W_PORT"" >> $HOME/.bash_profile
source $HOME/.bash_profile

printLine
echo -e "Moniker:        \e[1m\e[32m$W_MONIKER\e[0m"
echo -e "Wallet:         \e[1m\e[32m$W_WALLET\e[0m"
echo -e "Chain id:       \e[1m\e[32m$WARDEN_CHAIN_ID\e[0m"
echo -e "Node custom port:  \e[1m\e[32m$W_PORT\e[0m"
printLine
sleep 1

# Go kurulumunu gerçekleştirme
printGreen "2. Installing Go..." && sleep 1
cd $HOME
VER="1.23.0"
wget "https://golang.org/dl/go$VER.linux-amd64.tar.gz"
sudo rm -rf /usr/local/go
sudo tar -C /usr/local -xzf "go$VER.linux-amd64.tar.gz"
rm "go$VER.linux-amd64.tar.gz"
[ ! -f ~/.bash_profile ] && touch ~/.bash_profile
echo "export PATH=$PATH:/usr/local/go/bin:~/go/bin" >> ~/.bash_profile
source $HOME/.bash_profile
[ ! -d ~/go/bin ] && mkdir -p ~/go/bin

# Versiyon kontrolü
echo $(go version) && sleep 1

# Warden protocol binary kurulum
printGreen "3. Downloading Warden binary and setting up..." && sleep 1
cd $HOME
mkdir -p $HOME/.warden/cosmovisor/genesis/bin/
wget https://github.com/warden-protocol/wardenprotocol/releases/download/v0.5.2/wardend_Linux_x86_64.zip
unzip wardend_Linux_x86_64.zip
chmod +x wardend
rm -rf wardend_Linux_x86_64.zip
cd $HOME
mv $HOME/wardend $HOME/.warden/cosmovisor/genesis/bin/

# Cosmovisor ve binary için sembolik linkler oluşturma
sudo ln -s $HOME/.warden/cosmovisor/genesis $HOME/.warden/cosmovisor/current -f
sudo ln -s $HOME/.warden/cosmovisor/current/bin/wardend /usr/local/bin/wardend -f

# Cosmovisor kurulumu
printGreen "4. Installing Cosmovisor..." && sleep 1
go install cosmossdk.io/tools/cosmovisor/cmd/cosmovisor@v1.6.0

# Servis dosyası oluşturma
printGreen "5. Creating service file..." && sleep 1
sudo tee /etc/systemd/system/wardend.service > /dev/null << EOF
[Unit]
Description=warden node service
After=network-online.target

[Service]
User=$USER
ExecStart=$(which cosmovisor) run start
Restart=on-failure
RestartSec=10
LimitNOFILE=65535
Environment="DAEMON_HOME=$HOME/.warden"
Environment="DAEMON_NAME=wardend"
Environment="UNSAFE_SKIP_BACKUP=true"
Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:$HOME/.warden/cosmovisor/current/bin"

[Install]
WantedBy=multi-user.target
EOF

# Servis aktif etme
sudo systemctl daemon-reload
sudo systemctl enable wardend

# Node başlatma ve yapılandırma
printGreen "6. Initializing the node..."
wardend config set client chain-id ${WARDEN_CHAIN_ID}
wardend config set client keyring-backend test
wardend config set client node tcp://localhost:${W_PORT}57
wardend init ${W_MONIKER} --chain-id ${WARDEN_CHAIN_ID}

# Genesis ve Addrbook dosyalarının indirilmesi
printGreen "7. Downloading genesis and addrbook..."
wget -O $HOME/.warden/config/genesis.json "https://raw.githubusercontent.com/MictoNode/warden-protocol/refs/heads/main/genesis.json"
wget -O $HOME/.warden/config/addrbook.json "https://raw.githubusercontent.com/MictoNode/warden-protocol/refs/heads/main/addrbook.json"

# Gas fiyatları ve port ayarları
printGreen "8. Configuring custom ports and gas prices..." && sleep 1
sed -i 's|minimum-gas-prices =.*|minimum-gas-prices = "25000000award"|g' $HOME/.warden/config/app.toml
sed -i.bak -e "s%:1317%:${W_PORT}17%g;
s%:8080%:${W_PORT}80%g;
s%:9090%:${W_PORT}90%g;
s%:9091%:${W_PORT}91%g;
s%:8545%:${W_PORT}45%g;
s%:8546%:${W_PORT}46%g;
s%:6065%:${W_PORT}65%g" $HOME/.warden/config/app.toml

# P2P ve port yapılandırması
sed -i.bak -e "s%:26658%:${W_PORT}58%g;
s%:26657%:${W_PORT}57%g;
s%:6060%:${W_PORT}60%g;
s%:26656%:${W_PORT}56%g;
s%^external_address = \"\"%external_address = \"$(wget -qO- eth0.me):${W_PORT}56\"%;
s%:26660%:${W_PORT}60%g" $HOME/.warden/config/config.toml

# Seed ve peer yapılandırması
printGreen "9. Setting up peers and seeds..." && sleep 1
SEEDS="2d2c7af1c2d28408f437aef3d034087f40b85401@52.51.132.79:26656"
PEERS="7b26de79a9d13e74987d1053055f1c88502ec852@warden-chiado-peers.mictonode.com:11956,2d2c7af1c2d28408f437aef3d034087f40b85401@52.51.132.79:26656,fcaffd41eb7e3647fa953607449ff5e371c236b8@195.26.245.67:31656,5461e7642520a1f8427ffaa57f9d39cf345fcd47@54.72.190.0:26656"
sed -i -e "/^\[p2p\]/,/^\[/{s/^[[:space:]]*seeds *=.*/seeds = \"$SEEDS\"/}" \
       -e "/^\[p2p\]/,/^\[/{s/^[[:space:]]*persistent_peers *=.*/persistent_peers = \"$PEERS\"/}" $HOME/.warden/config/config.toml

# Pruning ayarları
printGreen "10. Configuring pruning..." && sleep 1
sed -i -e "s/^pruning *=.*/pruning = \"custom\"/" $HOME/.warden/config/app.toml
sed -i -e "s/^pruning-keep-recent *=.*/pruning-keep-recent = \"100\"/" $HOME/.warden/config/app.toml
sed -i -e "s/^pruning-interval *=.*/pruning-interval = \"10\"/" $HOME/.warden/config/app.toml
sed -i -e "s/^indexer *=.*/indexer = \"null\"/" $HOME/.warden/config/config.toml

# Snapshot indirme ve node başlatma
printGreen "11. Downloading snapshot and starting node..." && sleep 1
wardend tendermint unsafe-reset-all --home $HOME/.warden
if curl -s --head curl https://snapshots-testnet.unitynodes.com/warden-testnet/warden-testnet-latest.tar.lz4 | head -n 1 | grep "200" > /dev/null; then
  curl https://snapshots-testnet.unitynodes.com/warden-testnet/warden-testnet-latest.tar.lz4 | lz4 -dc - | tar -xf - -C $HOME/.warden
    else
  echo "no snapshot founded"
fi

# Servisi başlatma
sudo systemctl daemon-reload
sudo systemctl restart wardend

printGreen "Check logs: sudo journalctl -u wardend -f -o cat" && sleep 10
